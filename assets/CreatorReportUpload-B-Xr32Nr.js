const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-DtsW_xrU.js","assets/index-BP5YFlyp.js","assets/index-Cpn6Z0e0.css"])))=>i.map(i=>d[i]);
import{_ as Y,u as q,r as R,j as a,s as A}from"./index-BP5YFlyp.js";import{L as V}from"./loader-circle-BC4jqH9m.js";import{F as G}from"./file-spreadsheet-DOqBiMGl.js";import{X as ee}from"./x-g7em6QJH.js";import{C as te}from"./circle-check-big-QNW-He0O.js";import{C as re}from"./circle-alert-CfHPc9GY.js";function B(e){if(e==null)return"";if(typeof e=="number"||typeof e=="boolean"||typeof e=="string")return e;if(e instanceof Date){if(e.getUTCFullYear()<=1900){const t=e.getTime()-new Date("1899-12-30T00:00:00Z").getTime(),s=Math.round(t/1e3),i=Math.floor(s/3600),o=Math.floor(s%3600/60),l=s%60;return i>0&&o>0?`${i}h ${o}min`:i>0?`${i}h`:o>0&&l>0?`${o}m ${l}s`:o>0?`${o}m`:`${l}s`}return e.toISOString().split("T")[0]}if(typeof e=="object"){const t=e;if("result"in t&&"formula"in t)return t.result??"";if("richText"in t&&Array.isArray(t.richText))return t.richText.map(s=>s.text).join("");if("hyperlink"in t&&"text"in t)return t.text??"";if("error"in t)return""}return String(e)}function se(e){const t=[];let s=[],i="",o=!1;for(let d=0;d<e.length;d++){const c=e[d];o?c==='"'&&e[d+1]==='"'?(i+='"',d++):c==='"'?o=!1:i+=c:c==='"'?o=!0:c===","?(s.push(i),i=""):c===`
`||c==="\r"?(c==="\r"&&e[d+1]===`
`&&d++,s.push(i),s.some(g=>g.trim())&&t.push(s),s=[],i=""):i+=c}if((i||s.length)&&(s.push(i),s.some(d=>d.trim())&&t.push(s)),t.length<2)return[];const l=t[0];return t.slice(1).map(d=>{const c={};return l.forEach((g,j)=>{c[g.trim()]=(d[j]??"").trim()}),c})}async function ne(e){var j;const t=await e.arrayBuffer(),s=(j=e.name.split(".").pop())==null?void 0:j.toLowerCase();if(s==="csv"){const m=new TextDecoder("utf-8").decode(t);return se(m)}if(s==="xls")throw new Error("The .xls format is not supported. Please export as .xlsx or .csv.");const i=(await Y(async()=>{const{default:m}=await import("./exceljs.min-DtsW_xrU.js").then(y=>y.e);return{default:m}},__vite__mapDeps([0,1,2]))).default,o=new i.Workbook;await o.xlsx.load(t);const l=o.worksheets[0];if(!l||l.rowCount<2)throw new Error("File has no data");const d=l.getRow(1),c=new Map;if(d.eachCell((m,y)=>{const b=B(m.value);b&&c.set(y,String(b))}),c.size===0)throw new Error("No headers found in first row");const g=[];return l.eachRow((m,y)=>{if(y===1)return;const b={};let C=!1;m.eachCell({includeEmpty:!1},(I,E)=>{const r=c.get(E);r&&(b[r]=B(I.value),C=!0)}),C&&g.push(b)}),g}const ae=[[/^creators?$/,"creator_name"],[/date\/?time/,"date_range"],[/new\s*fans/,"new_fans_net"],[/active\s*fans/,"active_fans"],[/fans\s*with\s*renew/,"fans_renew_on"],[/renew\s*on\s*%|renew.*percent/,"renew_pct"],[/change.*expired|expired.*change/,"expired_change"],[/total\s*earn/,"total_earnings"],[/^message|message.*(?:net|earn)/,"message_earnings"],[/subscript.*(?:net|earn)|^subscription/,"subscription_earnings"],[/^tips|tips.*(?:net|earn)/,"tips_earnings"],[/avg.*spend.*spender|spend.*per.*spender/,"avg_spend_per_spender"],[/avg.*sub.*length|subscription.*length/,"avg_sub_length"],[/of\s*ranking|ranking/,"of_ranking"],[/^following$/,"following"],[/new\s*subscript/,"new_subs_earnings"],[/chargebacks?/,"chargebacks"],[/post.*earn|earning.*post/,"post_earnings"],[/stream.*earn|earning.*stream/,"stream_earnings"]];function oe(e){for(const[t,s]of ae)if(t.test(e))return s}function M(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).replace(/[$,]/g,"").trim();return parseFloat(t)||0}function ie(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).match(/(\d+)/);return t?parseInt(t[1]):0}function K(e){if(!e)return null;const s=String(e).match(/\d{4}-\d{2}-\d{2}/g);return s&&s.length>=2?s[1]:s&&s.length===1?s[0]:null}function ce(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).replace(/%/g,"").trim();return parseFloat(t)||0}function U(e){const t=e.replace(/[^0-9]/g,"");if(t.length>=6){const s=t.slice(0,2),i=t.slice(2,4);return`20${t.slice(4,6)}-${i}-${s}`}return"9999-99-99"}function le(e){return[...e].sort((t,s)=>U(t.name).localeCompare(U(s.name)))}function ge({onUploadComplete:e}){const{profile:t}=q(),[s,i]=R.useState(!1),[o,l]=R.useState([]),[d,c]=R.useState(!1),g=R.useRef(null),j=async r=>{try{if(r.size>10485760)throw new Error(`File too large (${(r.size/1024/1024).toFixed(1)} MB). Max 10 MB.`);if(!/\.(xlsx|xls|csv)$/i.test(r.name))throw new Error("Invalid file type.");const u=await ne(r);if(!u.length)throw new Error("Sheet is empty");if(u.length>1e4)throw new Error(`Too many rows (${u.length}).`);const N=u[0],x=new Map,w=[];for(const f of Object.keys(N)){const n=f.toLowerCase().trim();if(!n)continue;const h=oe(n);h?x.set(f,h):w.push(f)}const _=new Set(x.values());if(!_.has("creator_name"))throw new Error(`Missing "Creator" column. Found headers: ${Object.keys(N).join(", ")}`);if(!_.has("new_fans_net"))throw new Error(`Missing "New fans" column. Found headers: ${Object.keys(N).join(", ")}`);if(!_.has("expired_change"))throw new Error(`Missing "Change in expired fan count" column. Found headers: ${Object.keys(N).join(", ")}`);const{data:X}=await A.from("models").select("id, name"),Z=new Map((X??[]).map(f=>[f.name.toLowerCase().trim(),f.id])),$=[],D=[];let S=null,T=1;const z={};for(const[f,n]of x)z[n]=u[0][f];if(z.date_range){const n=String(z.date_range).match(/\d{4}-\d{2}-\d{2}/g);if(n&&n.length>=2&&n[0]!==n[1]){const h=new Date(n[0]+"T00:00:00"),F=new Date(n[1]+"T00:00:00");T=Math.max(1,Math.round((F.getTime()-h.getTime())/864e5)+1)}}for(const f of u){const n={};for(const[J,Q]of x)n[Q]=f[J];const h=String(n.creator_name??"").trim();if(!h)continue;const F=Z.get(h.toLowerCase());if(!F){$.includes(h)||$.push(h);continue}S||(S=K(n.date_range));const O=K(n.date_range)??S;if(!O)continue;const H=parseInt(String(n.new_fans_net??0))||0,P=parseInt(String(n.expired_change??0))||0,W=Math.max(0,H+P),v=T;D.push({model_id:F,date:O,new_fans:Math.round(W/v),active_fans:parseInt(String(n.active_fans??0))||0,fans_renew_on:parseInt(String(n.fans_renew_on??0))||0,renew_pct:ce(n.renew_pct),expired_change:Math.round(P/v),total_earnings:Math.round(M(n.total_earnings)/v*100)/100,message_earnings:Math.round(M(n.message_earnings)/v*100)/100,subscription_earnings:Math.round(M(n.subscription_earnings)/v*100)/100,tips_earnings:Math.round(M(n.tips_earnings)/v*100)/100,avg_spend_per_spender:M(n.avg_spend_per_spender),avg_sub_length_days:ie(n.avg_sub_length),of_ranking:n.of_ranking?String(n.of_ranking):null,following:parseInt(String(n.following??0))||0})}if(!D.length)throw new Error(`No models matched. Unmatched: ${$.slice(0,5).join(", ")}`);const{error:L}=await A.from("model_daily_stats").upsert(D,{onConflict:"model_id,date"});if(L)throw L;t&&await A.from("csv_uploads").insert({uploaded_by:t.id,file_name:r.name,row_count:D.length,upload_type:"creator_report",report_date:S||null});const k=[];return k.push(`Date: ${S}`),T>1&&k.push(`${T}-day range — values divided to daily averages`),k.push(`${D.length} models · ${_.size} columns mapped`),$.length>0&&k.push(`${$.length} unmatched models: ${$.join(", ")}`),w.length>0&&k.push(`Skipped columns: ${w.join(", ")}`),{fileName:r.name,type:"success",message:"Uploaded",details:k,reportDate:S}}catch(p){return{fileName:r.name,type:"error",message:p instanceof Error?p.message:"Upload failed"}}},m=async r=>{const p=le(r);i(!0),l(p.map(u=>({fileName:u.name,type:"pending",message:"Waiting..."})));for(let u=0;u<p.length;u++){l(x=>x.map((w,_)=>_===u?{...w,type:"processing",message:"Processing..."}:w));const N=await j(p[u]);l(x=>x.map((w,_)=>_===u?N:w))}i(!1),e==null||e()},y=r=>{const p=Array.from(r.target.files??[]);p.length>0&&m(p),r.target.value=""},b=r=>{r.preventDefault(),c(!1);const p=Array.from(r.dataTransfer.files);p.length>0&&m(p)},C=()=>l([]),I=o.filter(r=>r.type==="success").length,E=o.filter(r=>r.type==="error").length;return a.jsxs("div",{className:"space-y-3",children:[a.jsxs("label",{className:`flex flex-col items-center justify-center w-full h-28 rounded-lg border-2 border-dashed transition-colors cursor-pointer ${d?"border-cw bg-cw/10":"border-border hover:border-cw/50 hover:bg-surface-2/50"}`,onDragOver:r=>{r.preventDefault(),c(!0)},onDragLeave:()=>c(!1),onDrop:b,children:[s?a.jsxs("div",{className:"flex items-center gap-2 text-cw",children:[a.jsx(V,{className:"w-5 h-5 animate-spin"}),a.jsxs("span",{className:"text-sm",children:["Processing ",o.filter(r=>r.type==="success"||r.type==="error").length+1,"/",o.length,"..."]})]}):a.jsxs(a.Fragment,{children:[a.jsx(G,{className:"w-8 h-8 text-text-muted mb-1"}),a.jsxs("span",{className:"text-sm text-text-secondary",children:["Drop Creator Reports (.xlsx) or ",a.jsx("span",{className:"text-cw",children:"browse"})]}),a.jsx("span",{className:"text-[10px] text-text-muted mt-0.5",children:"Select multiple files — they'll be processed by date order"})]}),a.jsx("input",{ref:g,type:"file",accept:".xlsx,.xls,.csv",multiple:!0,className:"hidden",onChange:y,disabled:s})]}),o.length>0&&a.jsxs("div",{className:"rounded-lg border border-border overflow-hidden",children:[a.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-surface-2/50 border-b border-border",children:[a.jsx("span",{className:"text-xs text-text-secondary font-medium",children:s?`Processing ${o.filter(r=>r.type==="success"||r.type==="error").length}/${o.length}...`:`Done — ${I} uploaded${E>0?`, ${E} failed`:""}`}),!s&&a.jsx("button",{onClick:C,className:"text-text-muted hover:text-text-secondary",children:a.jsx(ee,{size:14})})]}),a.jsx("div",{className:"max-h-48 overflow-y-auto divide-y divide-border/50",children:o.map((r,p)=>a.jsxs("div",{className:"flex items-center gap-2 px-3 py-1.5 text-xs",children:[r.type==="success"&&a.jsx(te,{size:13,className:"text-success shrink-0"}),r.type==="error"&&a.jsx(re,{size:13,className:"text-danger shrink-0"}),r.type==="processing"&&a.jsx(V,{size:13,className:"text-cw animate-spin shrink-0"}),r.type==="pending"&&a.jsx("div",{className:"w-[13px] h-[13px] rounded-full border border-border shrink-0"}),a.jsx("span",{className:"text-text-primary truncate flex-1",children:r.fileName}),r.reportDate&&a.jsx("span",{className:"text-text-muted shrink-0",children:r.reportDate}),a.jsx("span",{className:`shrink-0 ${r.type==="success"?"text-success":r.type==="error"?"text-danger":"text-text-muted"}`,children:r.message})]},p))})]})]})}export{ge as C,ne as r};
