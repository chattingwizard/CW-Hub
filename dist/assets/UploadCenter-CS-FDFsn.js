import{u as O,r as p,j as e,s as k,U as z,l as I,x as H}from"./index-CYnCRFTw.js";import{F as $,r as B,C as K}from"./CreatorReportUpload-DmhML9J-.js";import{L as W}from"./loader-circle-BrfaFhvX.js";import{C as X}from"./circle-check-big-BnELrjZw.js";import{C as Z}from"./circle-alert-CgAouJ1b.js";import{C as V,a as Y}from"./chevron-up-CMAuF40Q.js";import{C as G}from"./clock-BuNhfYeB.js";const U={employee:"employee_name",employees:"employee_name",group:"team_from_report",team:"team_from_report",creators:"creators",creator:"creators",sales:"sales","ppv sales":"ppv_sales",tips:"tips","dm sales":"dm_sales","mass message sales":"mass_msg_sales","of mass message sales":"of_mass_msg_sales","messages sent":"messages_sent","ppvs sent":"ppvs_sent","ppvs unlocked":"ppvs_unlocked","character count":"character_count","golden ratio":"golden_ratio","unlock rate":"unlock_rate","fan cvr":"fan_cvr","fans chatted":"fans_chatted","fans who spent":"fans_who_spent","average earnings per spender":"avg_earnings_per_spender","avg earnings per spender":"avg_earnings_per_spender","response time (scheduled)":"response_time_scheduled","response time (clocked)":"response_time_clocked","scheduled hours":"scheduled_hours","clocked hours":"clocked_hours","sales per hour":"sales_per_hour","messages per hour":"messages_per_hour","fans per hour":"fans_per_hour"};function J(o){if(U[o])return U[o];if(o.startsWith("date/time")||o.startsWith("date"))return"date_range";for(const[d,n]of Object.entries(U))if(o.includes(d)||d.includes(o))return n}function a(o){if(typeof o=="number")return o;if(!o)return 0;const d=String(o).replace(/[$,%]/g,"").trim();return parseFloat(d)||0}function Q(o){if(!o)return null;const n=String(o).match(/\d{4}-\d{2}-\d{2}/g);if(n&&n.length>=2){const m=new Date(n[0]+"T00:00:00"),c=new Date(n[1]+"T00:00:00"),x=Math.max(1,Math.round((c.getTime()-m.getTime())/864e5)+1);return{date:n[1],days:x}}return n&&n.length===1?{date:n[0],days:1}:null}function ee({onUploadComplete:o}){var v;const{profile:d}=O(),[n,m]=p.useState(!1),[c,x]=p.useState(null),[w,u]=p.useState(!1),_=async s=>{m(!0),x(null);try{if(s.size>10485760)throw new Error(`File too large (${(s.size/1024/1024).toFixed(1)} MB). Maximum is 10 MB.`);if(!/\.(xlsx|xls|csv)$/i.test(s.name))throw new Error("Invalid file type. Please upload .xlsx, .xls, or .csv files only.");const l=await B(s);if(!l.length)throw new Error("Sheet is empty");if(l.length>1e4)throw new Error(`Too many rows (${l.length}). Maximum is 10,000.`);const g=l[0],N=new Map;for(const f of Object.keys(g)){const t=f.toLowerCase().trim(),i=J(t);i&&N.set(f,i)}const R=new Set(N.values());if(!R.has("employee_name"))throw new Error('Missing "Employee" column');if(!R.has("sales"))throw new Error('Missing "Sales" column');const{data:P}=await k.from("chatters").select("full_name, team_name").eq("status","Active").eq("airtable_role","Chatter"),M=new Map;for(const f of P??[])M.set(f.full_name.toLowerCase().trim(),f.team_name??"");let C=null,D=1;const y=[],h=[];for(const f of l){const t={};for(const[j,q]of N)t[q]=f[j];const i=String(t.employee_name??"").trim();if(!i)continue;if(!C&&t.date_range){const j=Q(t.date_range);j&&(C=j.date,D=j.days)}const L=M.get(i.toLowerCase().trim())??"";!L&&!M.has(i.toLowerCase().trim())&&(h.includes(i)||h.push(i));const F=a(t.clocked_hours);F<.5||y.push({date:C||new Date().toISOString().split("T")[0],employee_name:i,team:L,creators:String(t.creators??""),sales:a(t.sales),ppv_sales:a(t.ppv_sales),tips:a(t.tips),dm_sales:a(t.dm_sales),mass_msg_sales:a(t.mass_msg_sales),of_mass_msg_sales:a(t.of_mass_msg_sales),messages_sent:Math.round(a(t.messages_sent)),ppvs_sent:Math.round(a(t.ppvs_sent)),ppvs_unlocked:Math.round(a(t.ppvs_unlocked)),character_count:Math.round(a(t.character_count)),golden_ratio:a(t.golden_ratio),unlock_rate:a(t.unlock_rate),fan_cvr:a(t.fan_cvr),fans_chatted:Math.round(a(t.fans_chatted)),fans_who_spent:Math.round(a(t.fans_who_spent)),avg_earnings_per_spender:a(t.avg_earnings_per_spender),response_time_scheduled:t.response_time_scheduled?String(t.response_time_scheduled):null,response_time_clocked:t.response_time_clocked?String(t.response_time_clocked):null,scheduled_hours:a(t.scheduled_hours),clocked_hours:F,sales_per_hour:a(t.sales_per_hour),messages_per_hour:a(t.messages_per_hour),fans_per_hour:a(t.fans_per_hour)})}if(!y.length)throw new Error(`No valid rows found (chatters with >= 0.5 clocked hours). ${h.length>0?`Unmatched: ${h.slice(0,5).join(", ")}`:""}`);const{error:T}=await k.from("chatter_daily_stats").upsert(y,{onConflict:"date,employee_name"});if(T)throw T;await k.from("csv_uploads").insert({uploaded_by:d.id,file_name:s.name,row_count:y.length,upload_type:"employee_report"});const b=[];b.push(`Date: ${C||"today"}`),D>1&&b.push(`${D}-day range detected`),b.push(`${y.length} chatters uploaded`),h.length>0&&b.push(`${h.length} not in system: ${h.join(", ")}`),x({type:"success",message:"Employee Report uploaded!",details:b}),o==null||o()}catch(r){x({type:"error",message:r instanceof Error?r.message:"Upload failed"})}finally{m(!1)}},S=s=>{var l;const r=(l=s.target.files)==null?void 0:l[0];r&&_(r),s.target.value=""},E=s=>{s.preventDefault(),u(!1);const r=s.dataTransfer.files[0];r&&_(r)};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:`flex flex-col items-center justify-center w-full h-28 rounded-lg border-2 border-dashed transition-colors cursor-pointer ${w?"border-cw bg-cw/10":"border-border hover:border-cw/50 hover:bg-surface-2/50"}`,onDragOver:s=>{s.preventDefault(),u(!0)},onDragLeave:()=>u(!1),onDrop:E,children:[n?e.jsxs("div",{className:"flex items-center gap-2 text-cw",children:[e.jsx(W,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{className:"text-sm",children:"Processing Employee Report..."})]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-8 h-8 text-text-muted mb-1"}),e.jsxs("span",{className:"text-sm text-text-secondary",children:["Drop Employee Report (.csv / .xlsx) or ",e.jsx("span",{className:"text-cw",children:"browse"})]}),e.jsx("span",{className:"text-[10px] text-text-muted mt-0.5",children:"From Inflow > Employee Statistics"})]}),e.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",className:"hidden",onChange:S,disabled:n})]}),c&&e.jsx("div",{className:`rounded-lg p-3 text-sm ${c.type==="success"?"bg-success/10 border border-success/20":"bg-danger/10 border border-danger/20"}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[c.type==="success"?e.jsx(X,{className:"w-4 h-4 text-success shrink-0 mt-0.5"}):e.jsx(Z,{className:"w-4 h-4 text-danger shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:c.type==="success"?"text-success":"text-danger",children:c.message}),(v=c.details)==null?void 0:v.map((s,r)=>e.jsx("p",{className:"text-text-muted text-xs mt-0.5",children:s},r))]})]})})]})}const A=[{id:"creator_report",title:"Creator Report",description:"Infloww Creator Reports (.xlsx) — model revenue, fans, traffic, OF ranking",icon:$,format:".xlsx",frequency:"Daily",source:"Infloww → Creator Statistics → Export",color:"text-cw",bgColor:"bg-cw/10"},{id:"employee_report",title:"Employee Report",description:"Inflow Employee Reports (.csv/.xlsx) — chatter KPIs, sales, CVR, messages",icon:z,format:".csv / .xlsx",frequency:"Daily",source:"Inflow → Employee Statistics → Export",color:"text-success",bgColor:"bg-success/10"}];function ce(){const{profile:o}=O(),[d,n]=p.useState(null),[m,c]=p.useState([]),[x,w]=p.useState(!0),u=p.useCallback(async()=>{w(!0);const{data:s}=await k.from("csv_uploads").select("*, uploader:profiles!csv_uploads_uploaded_by_fkey(full_name)").order("uploaded_at",{ascending:!1}).limit(25);c(s??[]),w(!1)},[]);p.useEffect(()=>{u()},[u]);const _=()=>{n(null),u()},S=s=>{const r=A.find(l=>l.id===s);return(r==null?void 0:r.title)??s},E=s=>s==="creator_report"?e.jsx($,{size:14,className:"text-cw"}):s==="employee_report"?e.jsx(z,{size:14,className:"text-success"}):e.jsx(H,{size:14,className:"text-text-muted"}),v=s=>{const r=Date.now()-new Date(s).getTime(),l=Math.floor(r/6e4);if(l<1)return"just now";if(l<60)return`${l}m ago`;const g=Math.floor(l/60);return g<24?`${g}h ago`:`${Math.floor(g/24)}d ago`};return e.jsxs("div",{className:"p-4 lg:p-6 max-w-4xl mx-auto",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl font-extrabold text-text-primary",children:"Upload Center"}),e.jsx("p",{className:"text-text-secondary text-sm mt-1",children:"Upload daily reports. Data syncs automatically to all dashboards."})]}),e.jsx("div",{className:"grid gap-3 mb-8",children:A.map(s=>{const r=d===s.id;return e.jsxs("div",{className:`bg-surface-1 border rounded-xl overflow-hidden transition-all ${r?"border-cw/40":"border-border hover:border-border-light"}`,children:[e.jsxs("div",{className:"flex items-center gap-4 p-5 cursor-pointer",onClick:()=>n(r?null:s.id),children:[e.jsx("div",{className:`w-11 h-11 rounded-xl ${s.bgColor} flex items-center justify-center shrink-0`,children:e.jsx(s.icon,{size:22,className:s.color})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-bold text-text-primary",children:s.title}),e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded-full bg-surface-3 text-text-muted font-semibold",children:s.frequency})]}),e.jsx("p",{className:"text-sm text-text-secondary mt-0.5",children:s.description}),e.jsxs("p",{className:"text-[11px] text-text-muted mt-1",children:["Source: ",s.source," · Format: ",s.format]})]}),e.jsxs("div",{className:"shrink-0 flex items-center gap-2",children:[!r&&e.jsx("div",{className:"w-10 h-10 rounded-xl border border-dashed border-border-light flex items-center justify-center hover:border-cw/40 hover:bg-cw/5",children:e.jsx(I,{size:16,className:"text-text-muted"})}),r?e.jsx(V,{size:16,className:"text-text-muted"}):e.jsx(Y,{size:16,className:"text-text-muted"})]})]}),r&&e.jsxs("div",{className:"px-5 pb-5 border-t border-border pt-4",children:[s.id==="creator_report"&&e.jsx(K,{onUploadComplete:_}),s.id==="employee_report"&&e.jsx(ee,{onUploadComplete:_})]})]},s.id)})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(G,{size:16,className:"text-text-muted"}),e.jsx("h2",{className:"text-lg font-bold text-text-primary",children:"Recent Uploads"}),e.jsxs("span",{className:"text-xs text-text-muted ml-auto",children:[m.length," records"]})]}),x?e.jsx("div",{className:"bg-surface-1 border border-border rounded-xl p-8 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-text-secondary",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-cw/30 border-t-cw rounded-full animate-spin"}),"Loading history..."]})}):m.length===0?e.jsxs("div",{className:"bg-surface-1 border border-border rounded-xl p-8 text-center",children:[e.jsx(I,{size:24,className:"text-text-muted mx-auto mb-2"}),e.jsx("p",{className:"text-text-muted text-sm",children:"No uploads yet. Start by uploading a report above."})]}):e.jsx("div",{className:"bg-surface-1 border border-border rounded-xl overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left px-4 py-3 text-xs text-text-muted font-medium",children:"Type"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs text-text-muted font-medium",children:"File"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs text-text-muted font-medium",children:"Rows"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs text-text-muted font-medium",children:"Uploaded by"}),e.jsx("th",{className:"text-left px-4 py-3 text-xs text-text-muted font-medium",children:"When"})]})}),e.jsx("tbody",{children:m.map(s=>{var r;return e.jsxs("tr",{className:"border-b border-border/50 hover:bg-surface-2/30",children:[e.jsx("td",{className:"px-4 py-2.5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[E(s.upload_type),e.jsx("span",{className:"text-text-secondary text-xs font-medium",children:S(s.upload_type)})]})}),e.jsx("td",{className:"px-4 py-2.5",children:e.jsx("span",{className:"text-text-primary font-medium truncate max-w-[200px] block",children:s.file_name})}),e.jsx("td",{className:"px-4 py-2.5",children:e.jsx("span",{className:"text-text-secondary",children:s.row_count})}),e.jsx("td",{className:"px-4 py-2.5",children:e.jsx("span",{className:"text-text-secondary",children:((r=s.uploader)==null?void 0:r.full_name)??"Unknown"})}),e.jsx("td",{className:"px-4 py-2.5",children:e.jsx("span",{className:"text-text-muted text-xs",title:new Date(s.uploaded_at).toLocaleString(),children:v(s.uploaded_at)})})]},s.id)})})]})})})]})]})}export{ce as default};
