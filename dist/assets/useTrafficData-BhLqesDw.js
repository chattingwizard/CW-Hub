import{j as a,U as me,r as _,s as I}from"./index-CYnCRFTw.js";import{T as xe}from"./trending-up-z9uvJiNv.js";import{T as ue}from"./trending-down-B84inAc5.js";import{M as _e}from"./minus-D_s15HSc.js";const ge={"Free Page":{label:"Free",abbr:"F",bg:"bg-emerald-500/15",text:"text-emerald-400",border:"border-emerald-500/30"},"Paid Page":{label:"Paid",abbr:"P",bg:"bg-amber-500/15",text:"text-amber-400",border:"border-amber-500/30"},Mixed:{label:"Mix",abbr:"M",bg:"bg-purple-500/15",text:"text-purple-400",border:"border-purple-500/30"}},fe={label:"?",abbr:"?",bg:"bg-surface-2",text:"text-text-muted",border:"border-border"};function R({pageType:e,size:o="sm"}){const n=ge[e??""]??fe;return o==="sm"?a.jsx("span",{className:`text-[9px] font-bold px-1 py-px rounded ${n.bg} ${n.text}`,title:`${n.label} account`,children:n.abbr}):a.jsx("span",{className:`text-[10px] font-semibold px-1.5 py-0.5 rounded border ${n.bg} ${n.text} ${n.border}`,children:n.label})}function Q(e){return e>=70?"text-orange-400":e>=30?"text-cw":e>0?"text-slate-400":"text-text-muted"}function U(e){return e>=70?"bg-orange-500":e>=30?"bg-cw":e>0?"bg-slate-500":"bg-surface-2"}function X(e){return e>=110?{text:"text-danger",bg:"bg-danger/15"}:e>=85?{text:"text-success",bg:"bg-success/15"}:e>=60?{text:"text-warning",bg:"bg-warning/15"}:{text:"text-slate-400",bg:"bg-slate-500/15"}}const he={high:{bg:"bg-orange-500/15",text:"text-orange-400",bar:"bg-orange-500"},medium:{bg:"bg-cw/15",text:"text-cw",bar:"bg-cw"},low:{bg:"bg-slate-500/15",text:"text-slate-400",bar:"bg-slate-500"},none:{bg:"bg-surface-2",text:"text-text-muted",bar:"bg-surface-2"}};function Ne({traffic:e,size:o="sm",showBar:n=!0,showTrend:c=!1,showType:l=!0}){if(!e||e.workload_pct<=0)return a.jsx("span",{className:"text-[10px] text-text-muted bg-surface-2 px-1.5 py-0.5 rounded",children:"No data"});const i=e.workload_pct,h=U(i),g=Q(i),v=e.trend==="up"?xe:e.trend==="down"?ue:_e,k=e.trend==="up"?"text-green-400":e.trend==="down"?"text-red-400":"text-text-muted";return o==="sm"?a.jsxs("div",{className:"inline-flex items-center gap-1 group relative",title:`${i}% workload (${e.new_fans_avg} fans/day Ã— ${e.page_type??"Unknown"} weight) | ${e.chatters_assigned} chatters | ${e.active_fans.toLocaleString()} active fans`,children:[l&&a.jsx(R,{pageType:e.page_type,size:"sm"}),n&&a.jsx("div",{className:"w-10 h-1.5 bg-surface-2 rounded-full overflow-hidden",children:a.jsx("div",{className:`h-full rounded-full ${h}`,style:{width:`${Math.min(100,i)}%`}})}),a.jsxs("span",{className:`text-[10px] font-semibold ${g}`,children:[i,"%"]}),c&&e.trend!=="stable"&&a.jsx(v,{className:`w-2.5 h-2.5 ${k}`})]}):a.jsxs("div",{className:`inline-flex items-center gap-2 px-2 py-1 rounded-md ${he[e.level].bg}`,title:`${i}% workload | ${e.new_fans_avg} fans/day (${e.page_type??"Unknown"}) | $${e.earnings_per_day}/day`,children:[l&&a.jsx(R,{pageType:e.page_type,size:"md"}),n&&a.jsx("div",{className:"w-12 h-2 bg-black/20 rounded-full overflow-hidden",children:a.jsx("div",{className:`h-full rounded-full ${h}`,style:{width:`${Math.min(100,i)}%`}})}),a.jsxs("span",{className:`text-xs font-bold ${g}`,children:[i,"%"]}),c&&a.jsxs("div",{className:`flex items-center gap-0.5 ${k}`,children:[a.jsx(v,{className:"w-3 h-3"}),e.trend_pct!==0&&a.jsxs("span",{className:"text-[10px]",children:[e.trend_pct>0?"+":"",e.trend_pct,"%"]})]})]})}function $e({pct:e,label:o}){const n=X(e);return a.jsxs("span",{className:`inline-flex items-center gap-1 text-xs font-bold px-2 py-0.5 rounded-full ${n.bg} ${n.text}`,children:[e,"%",o&&a.jsx("span",{className:"font-normal text-[10px] opacity-75",children:o})]})}function Te({team:e,maxWorkloadPct:o}){const n=o??e.total_workload_pct,c=n>0?Math.min(100,e.total_workload_pct/n*100):0,l=X(e.workload_pct_per_chatter);return a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-xs text-text-secondary font-medium",children:e.team_name}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("span",{className:"text-[10px] text-text-muted",children:[a.jsx(me,{size:10,className:"inline mr-0.5 -mt-0.5"}),e.chatter_count]}),a.jsxs("span",{className:`text-xs font-bold ${l.text}`,children:[e.workload_pct_per_chatter,"%"]}),a.jsx("span",{className:"text-[10px] text-text-muted",children:"/chatter"})]})]}),a.jsx("div",{className:"h-3 bg-surface-2 rounded-full overflow-hidden relative",children:a.jsx("div",{className:`h-full transition-all duration-500 rounded-l-full ${U(e.workload_pct_per_chatter)}`,style:{width:`${c}%`}})}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("span",{className:"text-[9px] text-text-muted",children:[e.model_count," models:"]}),a.jsxs("div",{className:"flex gap-1",children:[e.free_count>0&&a.jsxs("span",{className:"text-[9px] px-1 rounded bg-emerald-500/15 text-emerald-400",children:[e.free_count,"F"]}),e.paid_count>0&&a.jsxs("span",{className:"text-[9px] px-1 rounded bg-amber-500/15 text-amber-400",children:[e.paid_count,"P"]}),e.mixed_count>0&&a.jsxs("span",{className:"text-[9px] px-1 rounded bg-purple-500/15 text-purple-400",children:[e.mixed_count,"M"]})]}),a.jsxs("span",{className:"text-[9px] text-text-muted ml-auto",children:["Team total: ",e.total_workload_pct,"%"]})]})]})}function Pe({traffic:e,rank:o}){const n=e.workload_pct,c=U(n),l=Q(n);return a.jsxs("div",{className:"flex items-center gap-3 py-1.5",children:[a.jsx("span",{className:"text-[10px] text-text-muted w-4 text-right shrink-0",children:o}),a.jsx(R,{pageType:e.page_type,size:"sm"}),a.jsx("div",{className:"flex-1 min-w-0",children:a.jsx("span",{className:"text-sm text-white truncate block",children:e.model_name})}),a.jsx("div",{className:"w-20 h-2 bg-surface-2 rounded-full overflow-hidden shrink-0",children:a.jsx("div",{className:`h-full rounded-full ${c}`,style:{width:`${Math.min(100,n)}%`}})}),a.jsx("div",{className:"text-right min-w-[50px] shrink-0",children:a.jsxs("span",{className:`text-xs font-bold ${l}`,children:[n,"%"]})}),a.jsx("div",{className:"text-right min-w-[60px] shrink-0",children:a.jsxs("span",{className:"text-[10px] text-text-muted",children:[Math.round(e.new_fans_avg)," fans/d"]})})]})}const we={"Free Page":1,Mixed:.7,"Paid Page":.4};function be(e){return we[e??""]??.7}function f(e){if(e.length===0)return 0;const o=[...e].sort((c,l)=>c-l),n=Math.floor(o.length/2);return o.length%2===0?(o[n-1]+o[n])/2:o[n]}function ve(e,o){if(e.length===0)return 0;const n=[...e].sort((h,g)=>h-g),c=o/100*(n.length-1),l=Math.floor(c),i=Math.ceil(c);return l===i?n[l]:n[l]+(n[i]-n[l])*(c-l)}function Se(){const[e,o]=_.useState([]),[n,c]=_.useState([]),[l,i]=_.useState(!0),[h,g]=_.useState(null),[v,k]=_.useState(0),$=_.useCallback(async()=>{i(!0),g(null);try{const x=new Date;x.setDate(x.getDate()-14);const T=x.toISOString().split("T")[0],[P,S,C]=await Promise.all([I.from("model_daily_stats").select("*").gte("date",T).order("date",{ascending:!1}),I.from("models").select("id, name, status, team_names, page_type"),I.from("model_chatter_assignments").select("model_id, chatter_id").eq("active",!0)]);if(P.error)throw P.error;if(S.error)throw S.error;if(C.error)throw C.error;const ee=P.data??[],B=S.data??[],O=C.data??[],G=new Map(B.map(t=>[t.id,t])),M=new Map;for(const t of O)M.set(t.model_id,(M.get(t.model_id)??0)+1);const y=new Map;for(const t of ee){const s=y.get(t.model_id)??[];s.push(t),y.set(t.model_id,s)}const D=new Date;D.setDate(D.getDate()-7);const V=D.toISOString().split("T")[0],p=[];for(const[t,s]of y){const r=G.get(t);if(!r)continue;const u=s.filter(d=>d.date>=V),q=s.filter(d=>d.date<V),w=f(u.map(d=>d.new_fans)),W=f(q.map(d=>d.new_fans)),m=s[0],re=(m==null?void 0:m.active_fans)??0,H=f(u.map(d=>d.total_earnings)),L=f(q.map(d=>d.total_earnings)),oe=f(u.map(d=>d.tips_earnings)),de=f(u.map(d=>d.message_earnings)),le=f(u.map(d=>d.subscription_earnings)),ce=(m==null?void 0:m.renew_pct)??0,ie=(m==null?void 0:m.avg_spend_per_spender)??0;let z="stable",N=0;W>0&&(N=(w-W)/W*100,N>10?z="up":N<-10&&(z="down"));let K=0;L>0&&(K=(H-L)/L*100);const b=M.get(t)??0,J=r.page_type??null,pe=be(J),A=w*pe;p.push({model_id:t,model_name:r.name,model_status:r.status??"Live",page_type:J,new_fans_avg:Math.round(w*10)/10,active_fans:re,chatters_assigned:b,fans_per_chatter:b>0?Math.round(w/b*10)/10:w,workload:Math.round(A*10)/10,workload_pct:0,workload_per_chatter:b>0?Math.round(A/b*10)/10:A,trend:z,trend_pct:Math.round(N),level:"none",team_names:r.team_names??[],earnings_per_day:Math.round(H*100)/100,tips_per_day:Math.round(oe*100)/100,message_earnings_per_day:Math.round(de*100)/100,subscription_earnings_per_day:Math.round(le*100)/100,earnings_trend_pct:Math.round(K),renew_pct:Math.round(ce*10)/10,avg_spend_per_spender:Math.round(ie*100)/100})}const te=new Set(y.keys());for(const t of B){if(te.has(t.id))continue;const s=M.get(t.id)??0;p.push({model_id:t.id,model_name:t.name,model_status:t.status??"Live",page_type:t.page_type??null,new_fans_avg:0,active_fans:0,chatters_assigned:s,fans_per_chatter:0,workload:0,workload_pct:0,workload_per_chatter:0,trend:"stable",trend_pct:0,level:"none",team_names:t.team_names??[],earnings_per_day:0,tips_per_day:0,message_earnings_per_day:0,subscription_earnings_per_day:0,earnings_trend_pct:0,renew_pct:0,avg_spend_per_spender:0})}const Y=p.map(t=>t.workload).filter(t=>t>0),ae=Y.length>0?ve(Y,90):.01,se=Math.max(ae,.01);for(const t of p)t.workload_pct=Math.round(t.workload/se*100);for(const t of p)t.workload_pct<=0?t.level="none":t.workload_pct>=70?t.level="high":t.workload_pct>=30?t.level="medium":t.level="low";const E=p.filter(t=>t.workload>0),ne=E.length>0?E.reduce((t,s)=>t+s.workload_pct,0)/E.length:0;k(Math.round(ne)),p.sort((t,s)=>s.workload_pct-t.workload_pct),o(p);const j=new Map;for(const t of p)for(const s of t.team_names){if(!s||s==="0")continue;const r=j.get(s)??{fans:0,active:0,workload:0,workloadPct:0,chatters:new Set,models:new Set,free:0,paid:0,mixed:0};r.fans+=t.new_fans_avg,r.active+=t.active_fans,r.workload+=t.workload,r.workloadPct+=t.workload_pct,r.models.add(t.model_id),t.page_type==="Free Page"?r.free++:t.page_type==="Paid Page"?r.paid++:r.mixed++,j.set(s,r)}for(const t of O){const s=G.get(t.model_id);if(s)for(const r of s.team_names??[]){const u=j.get(r);u&&u.chatters.add(t.chatter_id)}}const F=[];for(const[t,s]of j){const r=s.chatters.size||1;F.push({team_name:t,total_new_fans_avg:Math.round(s.fans*10)/10,total_active_fans:s.active,total_workload:Math.round(s.workload*10)/10,total_workload_pct:Math.round(s.workloadPct),chatter_count:s.chatters.size,model_count:s.models.size,fans_per_chatter:Math.round(s.fans/r*10)/10,workload_per_chatter:Math.round(s.workload/r*10)/10,workload_pct_per_chatter:Math.round(s.workloadPct/r),free_count:s.free,paid_count:s.paid,mixed_count:s.mixed})}F.sort((t,s)=>s.total_workload_pct-t.total_workload_pct),c(F)}catch(x){g(x instanceof Error?x.message:"Failed to load traffic data")}finally{i(!1)}},[]);_.useEffect(()=>{$()},[$]);const Z=_.useCallback(x=>e.find(T=>T.model_id===x),[e]);return{modelTraffic:e,teamTraffic:n,loading:l,error:h,refresh:$,getModelTraffic:Z,globalAvg:v}}export{Pe as M,R as P,Te as T,$e as W,Ne as a,Se as u};
