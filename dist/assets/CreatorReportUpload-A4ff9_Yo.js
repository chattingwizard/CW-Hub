const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exceljs.min-C6RCg2mi.js","assets/index-5iJEKlj_.js","assets/index-DeRXqBbJ.css"])))=>i.map(i=>d[i]);
import{c as q,_ as H,u as W,r as I,j as o,s as T}from"./index-5iJEKlj_.js";import{L as X}from"./loader-circle-D1kkN-CN.js";import{C as J}from"./circle-check-big-DzprXRFJ.js";import{C as Q}from"./circle-alert-DR0tKlAM.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=q("FileSpreadsheet",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M8 13h2",key:"yr2amv"}],["path",{d:"M14 13h2",key:"un5t4a"}],["path",{d:"M8 17h2",key:"2yhykz"}],["path",{d:"M14 17h2",key:"10kma7"}]]);function R(e){if(e==null)return"";if(typeof e=="number"||typeof e=="boolean"||typeof e=="string")return e;if(e instanceof Date)return e.toISOString().split("T")[0];if(typeof e=="object"){const t=e;if("result"in t&&"formula"in t)return t.result??"";if("richText"in t&&Array.isArray(t.richText))return t.richText.map(s=>s.text).join("");if("hyperlink"in t&&"text"in t)return t.text??"";if("error"in t)return""}return String(e)}function G(e){const t=[];let s=[],c="",d=!1;for(let i=0;i<e.length;i++){const a=e[i];d?a==='"'&&e[i+1]==='"'?(c+='"',i++):a==='"'?d=!1:c+=a:a==='"'?d=!0:a===","?(s.push(c),c=""):a===`
`||a==="\r"?(a==="\r"&&e[i+1]===`
`&&i++,s.push(c),s.some(h=>h.trim())&&t.push(s),s=[],c=""):c+=a}if((c||s.length)&&(s.push(c),s.some(i=>i.trim())&&t.push(s)),t.length<2)return[];const f=t[0];return t.slice(1).map(i=>{const a={};return f.forEach((h,x)=>{a[h.trim()]=(i[x]??"").trim()}),a})}async function Y(e){var x;const t=await e.arrayBuffer(),s=(x=e.name.split(".").pop())==null?void 0:x.toLowerCase();if(s==="csv"){const g=new TextDecoder("utf-8").decode(t);return G(g)}if(s==="xls")throw new Error("The .xls format is not supported. Please export as .xlsx or .csv.");const c=(await H(async()=>{const{default:g}=await import("./exceljs.min-C6RCg2mi.js").then(w=>w.e);return{default:g}},__vite__mapDeps([0,1,2]))).default,d=new c.Workbook;await d.xlsx.load(t);const f=d.worksheets[0];if(!f||f.rowCount<2)throw new Error("File has no data");const i=f.getRow(1),a=new Map;if(i.eachCell((g,w)=>{const n=R(g.value);n&&a.set(w,String(n))}),a.size===0)throw new Error("No headers found in first row");const h=[];return f.eachRow((g,w)=>{if(w===1)return;const n={};let l=!1;g.eachCell({includeEmpty:!1},(u,N)=>{const _=a.get(N);_&&(n[_]=R(u.value),l=!0)}),l&&h.push(n)}),h}const A={creator:"creator_name",creators:"creator_name","new fans":"new_fans_net","active fans":"active_fans","fans with renew on":"fans_renew_on","renew on %":"renew_pct","change in expired fan count":"expired_change","total earnings net":"total_earnings","message net":"message_earnings","subscription net":"subscription_earnings","tips net":"tips_earnings","avg spend per spender net":"avg_spend_per_spender","avg subscription length":"avg_sub_length","of ranking":"of_ranking",following:"following","new subscriptions net":"new_subs_earnings"};function ee(e){if(A[e])return A[e];if(e.startsWith("date/time"))return"date_range"}function j(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).replace(/[$,]/g,"").trim();return parseFloat(t)||0}function te(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).match(/(\d+)/);return t?parseInt(t[1]):0}function O(e){if(!e)return null;const s=String(e).match(/\d{4}-\d{2}-\d{2}/g);return s&&s.length>=2?s[1]:s&&s.length===1?s[0]:null}function re(e){if(typeof e=="number")return e;if(!e)return 0;const t=String(e).replace(/%/g,"").trim();return parseFloat(t)||0}function ie({onUploadComplete:e}){var w;const{profile:t}=W(),[s,c]=I.useState(!1),[d,f]=I.useState(null),[i,a]=I.useState(!1),h=async n=>{c(!0),f(null);try{if(n.size>10485760)throw new Error(`File too large (${(n.size/1024/1024).toFixed(1)} MB). Maximum is 10 MB.`);if(!/\.(xlsx|xls|csv)$/i.test(n.name))throw new Error("Invalid file type. Please upload .xlsx, .xls, or .csv files only.");const u=await Y(n);if(!u.length)throw new Error("Sheet is empty");if(u.length>1e4)throw new Error(`Too many rows (${u.length}). Maximum is 10,000.`);const N=u[0],_=new Map;for(const p of Object.keys(N)){const r=p.toLowerCase().trim(),m=ee(r);m&&_.set(p,m)}const D=new Set(_.values());if(!D.has("creator_name"))throw new Error('Missing "Creator" column');if(!D.has("new_fans_net"))throw new Error('Missing "New fans" column');if(!D.has("expired_change"))throw new Error('Missing "Change in expired fan count" column');const{data:P}=await T.from("models").select("id, name"),V=new Map((P??[]).map(p=>[p.name.toLowerCase().trim(),p.id])),y=[],M=[];let v=null,k=1;const E={};for(const[p,r]of _)E[r]=u[0][p];if(E.date_range){const r=String(E.date_range).match(/\d{4}-\d{2}-\d{2}/g);if(r&&r.length>=2&&r[0]!==r[1]){const m=new Date(r[0]+"T00:00:00"),C=new Date(r[1]+"T00:00:00");k=Math.max(1,Math.round((C.getTime()-m.getTime())/864e5)+1)}}for(const p of u){const r={};for(const[K,Z]of _)r[Z]=p[K];const m=String(r.creator_name??"").trim();if(!m)continue;const C=V.get(m.toLowerCase());if(!C){y.includes(m)||y.push(m);continue}v||(v=O(r.date_range));const $=O(r.date_range)??v;if(!$)continue;const z=parseInt(String(r.new_fans_net??0))||0,L=parseInt(String(r.expired_change??0))||0,B=Math.max(0,z+L),b=k;M.push({model_id:C,date:$,new_fans:Math.round(B/b),active_fans:parseInt(String(r.active_fans??0))||0,fans_renew_on:parseInt(String(r.fans_renew_on??0))||0,renew_pct:re(r.renew_pct),expired_change:Math.round(L/b),total_earnings:Math.round(j(r.total_earnings)/b*100)/100,message_earnings:Math.round(j(r.message_earnings)/b*100)/100,subscription_earnings:Math.round(j(r.subscription_earnings)/b*100)/100,tips_earnings:Math.round(j(r.tips_earnings)/b*100)/100,avg_spend_per_spender:j(r.avg_spend_per_spender),avg_sub_length_days:te(r.avg_sub_length),of_ranking:r.of_ranking?String(r.of_ranking):null,following:parseInt(String(r.following??0))||0})}if(!M.length)throw new Error(`No models matched. Unmatched names: ${y.slice(0,5).join(", ")}`);const{error:F}=await T.from("model_daily_stats").upsert(M,{onConflict:"model_id,date"});if(F)throw F;t&&await T.from("csv_uploads").insert({uploaded_by:t.id,file_name:n.name,row_count:M.length,upload_type:"creator_report"});const S=[];S.push(`Date: ${v}`),k>1&&S.push(`${k}-day range detected â€” values divided to daily averages`),S.push(`${M.length} models uploaded`),y.length>0&&S.push(`${y.length} unmatched: ${y.join(", ")}`),f({type:"success",message:"Creator Report uploaded successfully!",details:S}),e==null||e()}catch(l){f({type:"error",message:l instanceof Error?l.message:"Upload failed"})}finally{c(!1)}},x=n=>{var u;const l=(u=n.target.files)==null?void 0:u[0];l&&h(l),n.target.value=""},g=n=>{n.preventDefault(),a(!1);const l=n.dataTransfer.files[0];l&&h(l)};return o.jsxs("div",{className:"space-y-3",children:[o.jsxs("label",{className:`flex flex-col items-center justify-center w-full h-28 rounded-lg border-2 border-dashed transition-colors cursor-pointer ${i?"border-cw bg-cw/10":"border-border hover:border-cw/50 hover:bg-surface-2/50"}`,onDragOver:n=>{n.preventDefault(),a(!0)},onDragLeave:()=>a(!1),onDrop:g,children:[s?o.jsxs("div",{className:"flex items-center gap-2 text-cw",children:[o.jsx(X,{className:"w-5 h-5 animate-spin"}),o.jsx("span",{className:"text-sm",children:"Processing..."})]}):o.jsxs(o.Fragment,{children:[o.jsx(U,{className:"w-8 h-8 text-text-muted mb-1"}),o.jsxs("span",{className:"text-sm text-text-secondary",children:["Drop Creator Report (.xlsx) or ",o.jsx("span",{className:"text-cw",children:"browse"})]}),o.jsx("span",{className:"text-[10px] text-text-muted mt-0.5",children:"From Infloww > Creator Statistics"})]}),o.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",className:"hidden",onChange:x,disabled:s})]}),d&&o.jsx("div",{className:`rounded-lg p-3 text-sm ${d.type==="success"?"bg-success/10 border border-success/20":"bg-danger/10 border border-danger/20"}`,children:o.jsxs("div",{className:"flex items-start gap-2",children:[d.type==="success"?o.jsx(J,{className:"w-4 h-4 text-success shrink-0 mt-0.5"}):o.jsx(Q,{className:"w-4 h-4 text-danger shrink-0 mt-0.5"}),o.jsxs("div",{children:[o.jsx("p",{className:d.type==="success"?"text-success":"text-danger",children:d.message}),(w=d.details)==null?void 0:w.map((n,l)=>o.jsx("p",{className:"text-text-muted text-xs mt-0.5",children:n},l))]})]})})]})}export{ie as C,U as F,Y as r};
